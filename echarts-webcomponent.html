<script>
class EChartWebComponent extends HTMLElement {
    
    static get observedAttributes() {
        return ["style", "option"];
    }
    
    constructor() {
        super();
        const shadowRoot = this.attachShadow({mode: 'open'});
        shadowRoot.innerHTML = `
            <div id="container" style="width: 100%; height: 100%;"></div>
        `;
    }

    connectedCallback() {
        if (!this.chart) {
            let container = this.shadowRoot.querySelector("#container");
            this.chart = echarts.init(container);
            this.updateChart();
        }
    }

    disconnectedCallback() {
        let container = document.querySelector("#container");
        container.innerHTML = "";
        this.chart.dispose();
        this.chart = null;
    }

    attributeChangedCallback(name, oldValue, newValue) {
        if (name === "option") {
            this.updateChart();
        } else if (name === "style") {
            this.resizeChart();
        }
    }

    updateChart() {
        if (!this.chart) return;
        let option = JSON.parse(this.option || "{}");
        this.chart.setOption(option);;
    }

    resizeChart() {
        if (!this.chart) return;
        this.chart.resize();
    }

    get option() {
        if (this.hasAttribute("option")) {
            return this.getAttribute("option");
        } else {
            return "{}";
        }
    }

    set option(val) {
        if (val) {
            this.setAttribute("option", val);
        } else {
            this.setAttribute("option", "{}");
        }
        this.updateChart();
    }
}

window.addEventListener('WebComponentsReady', function(e) {
    window.customElements.define("echarts-webcomponent", EChartWebComponent);
});
</script>
